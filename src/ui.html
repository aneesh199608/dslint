<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Token Check</title>
    <style>
      :root {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #0f172a;
        background: #f8fafc;
      }
      body {
        margin: 0;
        padding: 16px;
      }
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .actions {
        display: flex;
        gap: 8px;
      }
      .actions {
        margin-top: 12px;
      }
      .icon-button {
        border: 1px solid #cbd5e1;
        background: linear-gradient(#ffffff, #f8fafc);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        color: #0f172a;
        cursor: pointer;
        transition: background 120ms ease, border-color 120ms ease;
      }
      .icon-button:hover {
        background: #eef2ff;
        border-color: #94a3b8;
      }
      .icon-button:active {
        background: #e2e8f0;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 14px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.04);
      }
      .card.success {
        background: #f0fdf4;
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 12px;
        margin-top: 8px;
      }
      .row-apply {
        border: 1px solid #cbd5e1;
        background: linear-gradient(#ffffff, #f8fafc);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        color: #0f172a;
        cursor: pointer;
        transition: background 120ms ease, border-color 120ms ease;
      }
      .row-apply:hover {
        background: #eef2ff;
        border-color: #94a3b8;
      }
      .primary-button {
        border: none;
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: white;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 13px;
        cursor: pointer;
        box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }
      .primary-button:hover {
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.25);
        transform: translateY(-1px);
      }
      .primary-button:active {
        transform: translateY(0);
        box-shadow: 0 4px 10px rgba(99, 102, 241, 0.2);
      }
      h2 {
        margin: 0 0 6px;
        font-size: 16px;
      }
      p {
        margin: 0;
        color: #475569;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div></div>
      <div class="actions">
        <button
          id="apply-all"
          class="primary-button"
          title="Apply nearest color tokens to all"
          aria-label="Apply nearest color tokens to all"
        >
          Apply Token to All
        </button>
        <button
          id="refresh"
          class="icon-button"
          title="Refresh report"
          aria-label="Refresh report"
        >
          Scan Again
        </button>
      </div>
    </div>
    <div class="card">
      <h2 id="title">Inspecting selection...</h2>
      <p id="message">Select a single rectangle to inspect.</p>
    </div>
    <div id="list"></div>
    <script>
      const titleEl = document.getElementById("title");
      const messageEl = document.getElementById("message");
      const refreshBtn = document.getElementById("refresh");
      const applyAllBtn = document.getElementById("apply-all");
      const cardEl = document.querySelector(".card");
      const listEl = document.getElementById("list");

      const renderList = (items) => {
        if (!listEl) return;
        if (!items || items.length === 0) {
          listEl.innerHTML = `<p style="color:#94a3b8;font-size:12px;margin-top:12px;">No nodes with fills found in selection.</p>`;
          return;
        }

        const rows = items
          .map((item) => {
            const statusColor =
              item.state === "found" || item.state === "applied"
                ? "#16a34a"
                : item.state === "error"
                ? "#b91c1c"
                : "#475569";
            const button =
              item.state === "missing"
                ? `<button data-id="${item.id}" class="row-apply">Apply Token</button>`
                : "";
            return `<div class="row">
              <div>
                <div style="font-weight:600;font-size:12px;">${item.name || "Layer"}</div>
                <div style="font-size:12px;color:${statusColor};">${item.message}</div>
              </div>
              ${button}
            </div>`;
          })
          .join("");
        listEl.innerHTML = rows;

        listEl.querySelectorAll(".row-apply").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            parent.postMessage({ pluginMessage: { type: "apply-token", nodeId: id } }, "*");
          });
        });
      };

      window.onmessage = (event) => {
        const data = event.data.pluginMessage;
        if (!data || data.type !== "status") return;
        const { title, message, state } = data.payload;
        titleEl.textContent = title;
        messageEl.textContent = message;
        cardEl?.classList.toggle(
          "success",
          state === "found" || state === "applied"
        );
      };

      window.addEventListener("message", (event) => {
        const data = event.data.pluginMessage;
        if (!data) return;
        if (data.type === "status") return; // handled above
        if (data.type === "scan-results") {
          renderList(data.payload.items || []);
        }
      });

      refreshBtn?.addEventListener("click", () => {
        parent.postMessage({ pluginMessage: { type: "refresh" } }, "*");
      });

      applyAllBtn?.addEventListener("click", () => {
        parent.postMessage({ pluginMessage: { type: "apply-token-all" } }, "*");
      });
    </script>
  </body>
</html>
