<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Token Check</title>
    <style>
      :root {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #0f172a;
        background: #f8fafc;
      }
      body {
        margin: 0;
        padding: 16px;
      }
      .top-bar {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 10px;
      }
      .row-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      .actions {
        display: flex;
        gap: 8px;
      }
      .icon-button {
        border: 1px solid #cbd5e1;
        background: linear-gradient(#ffffff, #f8fafc);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        color: #0f172a;
        cursor: pointer;
        transition: background 120ms ease, border-color 120ms ease;
      }
      .icon-button:hover {
        background: #eef2ff;
        border-color: #94a3b8;
      }
      .icon-button:active {
        background: #e2e8f0;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 14px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.04);
      }
      .card.success {
        background: #f0fdf4;
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 12px;
        margin-top: 8px;
      }
      .row-apply {
        border: 1px solid #cbd5e1;
        background: linear-gradient(#ffffff, #f8fafc);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        color: #0f172a;
        cursor: pointer;
        transition: background 120ms ease, border-color 120ms ease;
      }
      .row-apply:hover {
        background: #eef2ff;
        border-color: #94a3b8;
      }
      .row-highlight {
        border: 1px solid #e2e8f0;
        background: #ffffff;
        border-radius: 8px;
        padding: 6px;
        cursor: pointer;
        transition: background 120ms ease, border-color 120ms ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .row-highlight:hover {
        background: #eef2ff;
        border-color: #94a3b8;
      }
      .primary-button {
        border: none;
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: white;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 13px;
        cursor: pointer;
        box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }
      .primary-button:hover {
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.25);
        transform: translateY(-1px);
      }
      .primary-button:active {
        transform: translateY(0);
        box-shadow: 0 4px 10px rgba(99, 102, 241, 0.2);
      }
      h2 {
        margin: 0 0 6px;
        font-size: 16px;
      }
      p {
        margin: 0;
        color: #475569;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div class="row-flex">
        <div class="actions">
          <select id="filter" class="icon-button" title="Filter results">
            <option value="missing">Missing only</option>
            <option value="all">All</option>
          </select>
          <select id="theme" class="icon-button" title="Preferred mode">
            <option value="Light">Light</option>
            <option value="Dark">Dark</option>
          </select>
        </div>
        <button
          id="refresh"
          class="icon-button"
          title="Refresh report"
          aria-label="Refresh report"
        >
          Scan Again
        </button>
      </div>
      <div class="row-flex">
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;color:#475569;">
          <input type="checkbox" id="chk-fills" checked />
          Fills
        </label>
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;color:#475569;">
          <input type="checkbox" id="chk-strokes" checked />
          Strokes
        </label>
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;color:#475569;">
          <input type="checkbox" id="chk-typo" checked />
          Typography
        </label>
        <button
          id="apply-all"
          class="primary-button"
          title="Apply nearest tokens to all"
          aria-label="Apply nearest tokens to all"
        >
          Apply Token to All
        </button>
      </div>
    </div>
    <div class="card">
      <h2 id="title">Inspecting selection...</h2>
      <p id="message">Select a single rectangle to inspect.</p>
    </div>
    <p id="dark-note" style="display:none;font-size:12px;color:#475569;margin:8px 0 0;">
      Using Dark modeâ€”remember to set Figma's Appearance to Dark so tokens resolve correctly.
    </p>
    <div id="list"></div>
    <script>
      const titleEl = document.getElementById("title");
      const messageEl = document.getElementById("message");
      const refreshBtn = document.getElementById("refresh");
      const applyAllBtn = document.getElementById("apply-all");
      const themeSelect = document.getElementById("theme");
      const filterSelect = document.getElementById("filter");
      const chkFills = document.getElementById("chk-fills");
      const chkStrokes = document.getElementById("chk-strokes");
      const chkTypo = document.getElementById("chk-typo");
      const cardEl = document.querySelector(".card");
      const listEl = document.getElementById("list");
      const darkNote = document.getElementById("dark-note");

      const getMode = () => {
        const val = themeSelect?.value === "Dark" ? "Dark" : "Light";
        return val;
      };

      const updateDarkNote = () => {
        if (!darkNote) return;
        const isDark = getMode() === "Dark";
        darkNote.style.display = isDark ? "block" : "none";
      };

      const renderList = (items) => {
        if (!listEl) return;
        if (!items || items.length === 0) {
          listEl.innerHTML = `<p style="color:#94a3b8;font-size:12px;margin-top:12px;">No nodes with fills found in selection.</p>`;
          return;
        }

        const activeFilter = filterSelect?.value === "all" ? "all" : "missing";
        const filtered = activeFilter === "missing" ? items.filter((i) => i.state === "missing") : items;

        const rows = filtered
          .map((item) => {
            const statusColor =
              item.state === "found" || item.state === "applied"
                ? "#16a34a"
                : item.state === "error"
                ? "#b91c1c"
                : "#475569";
            const highlight = `<button data-id="${item.id}" class="row-highlight" title="Highlight in canvas">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3.5"/>
                <line x1="12" y1="2" x2="12" y2="6"/>
                <line x1="12" y1="18" x2="12" y2="22"/>
                <line x1="2" y1="12" x2="6" y2="12"/>
                <line x1="18" y1="12" x2="22" y2="12"/>
              </svg>
            </button>`;
            const fillStatus = item.fill
              ? `<div style="font-size:12px;color:${item.fill.state === "missing" ? "#b91c1c" : statusColor};">Fill: ${item.fill.message}</div>`
              : "";
            const strokeStatus = item.stroke
              ? `<div style="font-size:12px;color:${item.stroke.state === "missing" ? "#b91c1c" : statusColor};">Stroke: ${item.stroke.message}</div>`
              : "";
            const typoStatus = item.typography
              ? `<div style="font-size:12px;color:${item.typography.state === "missing" ? "#b91c1c" : statusColor};">Typography: ${item.typography.message}</div>`
              : "";

            const fillBtn =
              item.fill?.state === "missing"
                ? `<button data-id="${item.id}" data-target="fill" class="row-apply">Apply Fill Token</button>`
                : "";
            const strokeBtn =
              item.stroke?.state === "missing"
                ? `<button data-id="${item.id}" data-target="stroke" class="row-apply">Apply Stroke Token</button>`
                : "";
            const typoBtn =
              item.typography?.state === "missing"
                ? `<button data-id="${item.id}" data-target="typography" class="row-apply">Apply Typography Token</button>`
                : "";

            const buttons = `<div style="display:flex;align-items:center;gap:6px;">${highlight}${fillBtn}${strokeBtn}${typoBtn}</div>`;
            return `<div class="row" data-id="${item.id}">
              <div>
                <div style="font-weight:600;font-size:12px;">${item.name || "Layer"}</div>
                ${fillStatus || ""}
                ${strokeStatus || ""}
                ${typoStatus || ""}
              </div>
              ${buttons}
            </div>`;
          })
          .join("");
        listEl.innerHTML = rows;

        listEl.querySelectorAll(".row-apply").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            const target = btn.getAttribute("data-target") || "fill";
            parent.postMessage(
              { pluginMessage: { type: "apply-token", nodeId: id, target, mode: getMode() } },
              "*"
            );
          });
        });

        listEl.querySelectorAll(".row-highlight").forEach((btn) => {
          btn.addEventListener("mouseenter", () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            parent.postMessage(
              { pluginMessage: { type: "highlight", nodeId: id, mode: getMode() } },
              "*"
            );
          });
          btn.addEventListener("mouseleave", () => {
            parent.postMessage({ pluginMessage: { type: "highlight-clear" } }, "*");
          });
        });
      };

      window.onmessage = (event) => {
        const data = event.data.pluginMessage;
        if (!data || data.type !== "status") return;
        const { title, message, state } = data.payload;
        titleEl.textContent = title;
        messageEl.textContent = message;
        cardEl?.classList.toggle(
          "success",
          state === "found" || state === "applied"
        );
      };

      window.addEventListener("message", (event) => {
        const data = event.data.pluginMessage;
        if (!data) return;
        if (data.type === "status") return; // handled above
        if (data.type === "scan-results") {
          renderList(data.payload.items || []);
        }
      });

      refreshBtn?.addEventListener("click", () => {
        parent.postMessage({ pluginMessage: { type: "refresh", mode: getMode() } }, "*");
      });

      applyAllBtn?.addEventListener("click", () => {
        parent.postMessage(
          {
            pluginMessage: {
              type: "apply-token-all",
              mode: getMode(),
              fills: chkFills?.checked !== false,
              strokes: chkStrokes?.checked !== false,
              typography: chkTypo?.checked !== false,
            },
          },
          "*"
        );
      });

      themeSelect?.addEventListener("change", () => {
        updateDarkNote();
      });

      filterSelect?.addEventListener("change", () => {
        // Re-render with the current cached list; easiest is to trigger a refresh.
        parent.postMessage({ pluginMessage: { type: "refresh", mode: getMode() } }, "*");
      });

      updateDarkNote();

      const sendSize = () => {
        parent.postMessage(
          {
            pluginMessage: {
              type: "ui-resized",
              width: window.innerWidth,
              height: window.innerHeight,
            },
          },
          "*"
        );
      };
      window.addEventListener("resize", sendSize);
    </script>
  </body>
</html>
